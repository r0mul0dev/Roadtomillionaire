<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Apuestas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="container py-4">
    <div class="mb-3"><a href="dashboard.html" class="text-secondary text-decoration-none">← Volver</a></div>
    
    <div class="card bg-primary text-white p-4 mb-4 shadow text-center">
        <h2 id="nomReto">---</h2>
        <h1 class="display-4">Banco: <span id="bancoDisplay">$0</span></h1>
        <p class="mb-0">Objetivo: <span id="metaDisplay">$0</span></p>
    </div>

    <form id="betForm" class="row g-2 mb-4 p-3 bg-white border rounded shadow-sm">
        <div class="col-md-3"><input type="number" id="monto" class="form-control" placeholder="Monto $" required></div>
        <div class="col-md-2"><input type="number" step="0.01" id="cuota" class="form-control" placeholder="Cuota" required></div>
        <div class="col-md-4">
            <select id="status" class="form-select">
                <option value="en espera">En Espera (Obligatorio)</option>
                <option value="ganado">Ganado</option>
                <option value="perdido">Perdido</option>
            </select>
        </div>
        <div class="col-md-3"><button type="submit" class="btn btn-primary w-100">Registrar</button></div>
    </form>

    <table class="table table-striped align-middle">
        <thead class="table-dark">
            <tr><th>Monto</th><th>Cuota</th><th>G. Potencial</th><th>Status</th></tr>
        </thead>
        <tbody id="tablaBets"></tbody>
    </table>

    <script>
        const supabase = supabase.createClient('TU_URL', 'TU_KEY');
        const id = new URLSearchParams(window.location.search).get('id');

        async function cargarPagina() {
            const { data: r } = await supabase.from('challenges').select('*').eq('id', id).single();
            document.getElementById('nomReto').innerText = r.nombre;
            document.getElementById('bancoDisplay').innerText = `$${r.banco_actual}`;
            document.getElementById('metaDisplay').innerText = `$${r.monto_objetivo}`;
            
            const { data: bets } = await supabase.from('bets').select('*').eq('challenge_id', id).order('created_at', { ascending: false });
            document.getElementById('tablaBets').innerHTML = bets.map(b => `
                <tr>
                    <td>$${b.monto_apostado}</td>
                    <td>${b.cuota}</td>
                    <td>$${(b.monto_apostado * b.cuota).toFixed(2)}</td>
                    <td><span class="badge bg-${b.status==='ganado'?'success':b.status==='perdido'?'danger':'warning'}">${b.status}</span></td>
                </tr>
            `).join('');
        }

        document.getElementById('betForm').onsubmit = async (e) => {
            e.preventDefault();
            const m = parseFloat(document.getElementById('monto').value);
            const c = parseFloat(document.getElementById('cuota').value);
            const s = document.getElementById('status').value;

            // 1. Guardar Apuesta
            await supabase.from('bets').insert([{ challenge_id: id, monto_apostado: m, cuota: c, status: s }]);

            // 2. Lógica de Banco
            const { data: r } = await supabase.from('challenges').select('banco_actual, monto_objetivo').eq('id', id).single();
            let nuevoBanco = r.banco_actual - m;
            if (s === 'ganado') nuevoBanco += (m * c);

            let nuevoEstado = 'activo';
            if (nuevoBanco >= r.monto_objetivo) nuevoEstado = 'completado';
            if (nuevoBanco <= 0) nuevoEstado = 'perdido';

            await supabase.from('challenges').update({ banco_actual: nuevoBanco, estado: nuevoEstado }).eq('id', id);
            location.reload();
        };
        cargarPagina();
    </script>
</body>
</html>